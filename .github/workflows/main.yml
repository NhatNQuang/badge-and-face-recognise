name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH to VM
    runs-on: ubuntu-24.04
    
    steps:
    - name: Check secrets existence
      run: |
        echo "Checking if secrets are configured..."
        echo "VM_HOST exists: ${{ secrets.VM_HOST != '' }}"
        echo "VM_USERNAME exists: ${{ secrets.VM_USERNAME != '' }}"
        echo "VM_SSH_KEY exists: ${{ secrets.VM_SSH_KEY != '' }}"
        echo "VM_SSH_PORT exists: ${{ secrets.VM_SSH_PORT != '' }}"
        echo "VM_DEPLOY_PATH exists: ${{ secrets.VM_DEPLOY_PATH != '' }}"
    
    - name: Check SSH key format
      run: |
        echo "Checking SSH key format..."
        KEY_LENGTH=$(echo "${{ secrets.VM_SSH_KEY }}" | wc -c)
        echo "Key length: $KEY_LENGTH characters"
        
        if echo "${{ secrets.VM_SSH_KEY }}" | base64 -d >/dev/null 2>&1; then
          echo "âœ… Key is base64 encoded"
          echo "${{ secrets.VM_SSH_KEY }}" | base64 -d | head -n1
          echo "${{ secrets.VM_SSH_KEY }}" | base64 -d | tail -n1
        else
          echo "âŒ Key is NOT base64 encoded"
          exit 1
        fi
    
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        echo "${{ secrets.VM_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        echo "âœ… SSH key saved"
        
        # Show key fingerprint
        ssh-keygen -lf ~/.ssh/deploy_key
    
    - name: Test SSH with verbose
      run: |
        echo "ðŸ”Œ Testing SSH connection..."
        echo "Host: ${{ secrets.VM_HOST }}"
        echo "User: ${{ secrets.VM_USERNAME }}"
        echo "Port: ${{ secrets.VM_SSH_PORT }}"
        
        # Test with verbose mode
        ssh -vvv -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
          "echo 'Connected!' && whoami"