name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: cd src/core && pip install -r requirements.txt
      - run: pip install flake8 && flake8 src/core --count --select=E9,F63,F7,F82 --show-source --statistics

  build:
    name: Build Docker Images
    runs-on: ubuntu-24.04
    needs: test
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - run: docker build -t ai-backend:${{ github.sha }} ./src/core
      - run: docker build -t ui-frontend:${{ github.sha }} ./ui
      - run: docker images

  deploy:
    name: Deploy to Production VM
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      # ←←← ĐÂY LÀ 1 STEP DUY NHẤT CHẠY TOÀN BỘ SSH + DEPLOY ←←←
      - name: Deploy to VM (All-in-One + ssh-agent)
        run: |
          echo "=== SSH Setup ==="
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          install -m 600 /dev/stdin ~/.ssh/deploy_key <<< "$(echo '${{ secrets.VM_SSH_KEY }}' | base64 -d)"
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/deploy_key

          echo "=== Test SSH Connection ==="
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
              "echo 'SSH OK • $(whoami)@$(hostname)' && uptime" || exit 1

          echo "=== Starting Production Deployment ==="
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=3 \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            echo "→ Navigating to project directory"
            cd ${{ secrets.VM_DEPLOY_PATH }}

            echo "→ Pulling latest code"
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            echo "→ Stopping old containers & cleanup"
            docker compose down || docker-compose down || true
            docker system prune -af --volumes || true

            echo "→ Starting new containers"
            docker compose up -d --build

            echo "→ Waiting for services"
            sleep 20

            echo "→ Container status"
            docker compose ps

            echo "→ Health check backend (port 6034)"
            for i in {1..30}; do
              curl -f http://localhost:6034/health >/dev/null 2>&1 && echo "Backend healthy!" && break
              echo "Attempt $i/30: waiting backend..."
              sleep 2
            done

            echo "→ Health check frontend (port 6033)"
            curl -f http://localhost:6033 >/dev/null 2>&1 && echo "Frontend is up!" || echo "Frontend not ready (continue anyway)"

            echo "DEPLOYMENT COMPLETED SUCCESSFULLY!"
          EOF

          echo "Pipeline finished — everything deployed!"

  notify:
    name: Slack Notification
    runs-on: ubuntu-24.04
    needs: [test, build, deploy]
    if: always()
    steps:
      - name: Send Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && echo "No webhook → skip" && exit 0
          STATUS="${{ needs.deploy.result }}"
          [ "$STATUS" = "success" ] && COLOR=good TEXT="Deploy thành công" || COLOR=danger TEXT="Deploy thất bại"
          curl -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' \
            --data "{\"attachments\":[{\"color\":\"$COLOR\",\"title\":\"$TEXT • ${{ github.ref_name }}\",\"fields\":[{\"title\":\"Commit\",\"value\":\"<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\"},{\"title\":\"Run\",\"value\":\"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Log>\"}]}]}"
