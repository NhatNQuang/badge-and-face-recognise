name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_COMPOSE_VERSION: 2.23.0

jobs:
  test: 
    name: Run Tests
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code and download the latest code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd src/core
        pip install -r requirements.txt
        
    - name: Run linting
      run: |
        pip install flake8
        flake8 src/core --count --select=E9,F63,F7,F82 --show-source --statistics
  
  build:
    name: Build Docker Images
    runs-on: ubuntu-24.04
    needs: test
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build AI Backend Image
      run: |
        docker build -t ai-backend:${{ github.sha }} ./src/core
        
    - name: Build UI Frontend Image
      run: |
        docker build -t ui-frontend:${{ github.sha }} ./ui
        
    - name: Test images
      run: |
        docker images

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug - Show environment info
      run: |
        echo "üîç Debug Information"
        echo "===================="
        echo "Runner OS: $(uname -a)"
        echo "User: $(whoami)"
        echo "Home: $HOME"
        echo "Current directory: $(pwd)"
        echo ""
        echo "SSH Client version:"
        ssh -V
        echo ""
        
    - name: Setup SSH key with detailed logging
      run: |
        echo "üìÅ Setting up SSH directory..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        echo "üîë Decoding SSH key..."
        echo "${{ secrets.VM_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
        
        echo "üìù SSH key file info:"
        ls -la ~/.ssh/deploy_key
        
        echo "üîí Setting permissions..."
        chmod 600 ~/.ssh/deploy_key
        
        echo "‚úÖ Verifying key format..."
        head -n 1 ~/.ssh/deploy_key
        
        echo "üìã Key fingerprint:"
        ssh-keygen -lf ~/.ssh/deploy_key || echo "‚ö†Ô∏è Could not read key fingerprint"
        
    - name: Test SSH connection (verbose)
      continue-on-error: true
      run: |
        echo "üîå Testing SSH connection..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o IdentitiesOnly=yes \
          -o LogLevel=VERBOSE \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
          'echo "‚úÖ SSH connection successful!"' 2>&1 || {
            echo "‚ùå SSH connection failed"
            echo "Trying with different debug level..."
            ssh -vvv -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o IdentitiesOnly=yes \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
              'echo "Connection test"' 2>&1 | tail -20
          }
    
    - name: Verify VM access and docker
      run: |
        echo "üîç Checking VM environment..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o IdentitiesOnly=yes \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'ENDSSH'
            echo "‚úÖ Connected to VM"
            echo "User: $(whoami)"
            echo "Home: $HOME"
            echo "Current dir: $(pwd)"
            echo ""
            echo "üì¶ Docker version:"
            docker --version || echo "‚ö†Ô∏è Docker not found"
            echo ""
            echo "üì¶ Docker Compose version:"
            docker compose version || docker-compose --version || echo "‚ö†Ô∏è Docker Compose not found"
            echo ""
            echo "üìÅ Project directory:"
            ls -la ${{ secrets.VM_DEPLOY_PATH }} 2>/dev/null || echo "‚ö†Ô∏è Project directory not found"
            echo ""
            echo "üîê Docker permissions:"
            groups | grep -q docker && echo "‚úÖ User in docker group" || echo "‚ö†Ô∏è User not in docker group"
        ENDSSH
        
    - name: Deploy to production VM
      run: |
        echo "üöÄ Starting deployment..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o IdentitiesOnly=yes \
          -o ServerAliveInterval=60 \
          -o ServerAliveCountMax=3 \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'ENDSSH'
          set -e
          
          echo "üìÇ Navigating to project directory..."
          cd ${{ secrets.VM_DEPLOY_PATH }}
          
          echo "üì• Pulling latest code from main branch..."
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          echo "üõë Stopping existing containers..."
          docker compose down || docker-compose down || true
          
          echo "üßπ Cleaning up old images..."
          docker system prune -af --volumes
          
          echo "üèóÔ∏è Building and starting containers..."
          docker compose up -d --build || docker-compose up -d --build
          
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          echo "üîç Checking container status..."
          docker compose ps || docker-compose ps
          
          echo "üìä Checking backend health..."
          for i in {1..30}; do
            if curl -f http://localhost:6034/health 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            echo "‚è≥ Attempt $i/30: Backend not ready yet..."
            sleep 2
          done
          
          echo "üìä Checking frontend..."
          if curl -f http://localhost:6033 2>/dev/null; then
            echo "‚úÖ Frontend is accessible!"
          else
            echo "‚ö†Ô∏è Frontend check failed, but continuing..."
          fi
          
          echo "üìã Container logs (last 50 lines):"
          docker compose logs --tail=50 || docker-compose logs --tail=50
          
          echo "‚úÖ Deployment completed successfully!"
        ENDSSH
        
    - name: Verify deployment
      if: success()
      run: |
        echo "‚úÖ Verifying deployment..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'ENDSSH'
          cd ${{ secrets.VM_DEPLOY_PATH }}
          echo "üìä Running containers:"
          docker compose ps
          echo ""
          echo "üíæ Disk usage:"
          df -h | grep -E '(Filesystem|/$)'
          echo ""
          echo "üê≥ Docker disk usage:"
          docker system df
        ENDSSH
        
    - name: Rollback on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed! Attempting rollback..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'ENDSSH'
          cd ${{ secrets.VM_DEPLOY_PATH }}
          echo "‚èÆÔ∏è Rolling back to previous version..."
          git reset --hard HEAD~1
          docker compose down || true
          docker compose up -d --build
        ENDSSH
           
  notify:
    name: Send Notification
    runs-on: ubuntu-24.04
    needs: [test, build, deploy]
    if: always()

    steps:
    - name: Send Slack notification
      continue-on-error: true
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" == "success" ]; then
            COLOR="good"
            EMOJI="‚úÖ"
          elif [ "$STATUS" == "failure" ]; then
            COLOR="danger"
            EMOJI="‚ùå"
          else
            COLOR="warning"
            EMOJI="‚ö†Ô∏è"
          fi
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI CI/CD Pipeline $STATUS\",
                \"fields\": [
                  {
                    \"title\": \"Status\",
                    \"value\": \"$STATUS\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Commit\",
                    \"value\": \"<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Workflow\",
                    \"value\": \"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\",
                    \"short\": false
                  }
                ],
                \"footer\": \"GitHub Actions\",
                \"footer_icon\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                \"ts\": $(date +%s)
              }]
            }"
          echo "‚úÖ Slack notification sent"
        else
          echo "‚ö†Ô∏è SLACK_WEBHOOK_URL not configured, skipping notification"
        fi