name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: cd src/core && pip install -r requirements.txt
      - run: pip install flake8 && flake8 src/core --count --select=E9,F63,F7,F82 --show-source --statistics

  build:
    name: Build Docker Images
    runs-on: ubuntu-24.04
    needs: test
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - run: docker build -t ai-backend:${{ github.sha }} ./src/core
      - run: docker build -t ui-frontend:${{ github.sha }} ./ui
      - run: docker images

  deploy:
    name: Deploy to Production VM
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      # ←←← ĐÂY LÀ 1 STEP DUY NHẤT CHẠY TOÀN BỘ SSH + DEPLOY ←←←
      - name: Deploy to VM (All-in-One + ssh-agent)  # FINAL VERSION - 100% WORK
        run: |
          echo "=== SSH Setup ==="
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # ←←← DÒNG QUAN TRỌNG NHẤT: dùng printf để tránh \r\n
          printf '%s\n' "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Kiểm tra key có bị hỏng không
          echo "Key fingerprint after write:"
          ssh-keygen -l -f ~/.ssh/deploy_key || exit 1

          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/deploy_key

          echo "=== Test SSH Connection ==="
          ssh -vvv \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
              "echo 'SSH OK • deployer@$(hostname)' && whoami && uptime" && echo "SSH SUCCESS!" || exit 1

          echo "=== Deploying... ==="
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.VM_DEPLOY_PATH }}
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            docker compose down || true
            docker system prune -af --volumes || true
            docker compose up -d --build
            sleep 20
            docker compose ps
            echo "DEPLOYMENT COMPLETED SUCCESSFULLY!"
          EOF

          echo "Pipeline finished — DEPLOY XANH MƯỚT!"

  notify:
    name: Slack Notification
    runs-on: ubuntu-24.04
    needs: [test, build, deploy]
    if: always()
    steps:
      - name: Send Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && echo "No webhook → skip" && exit 0
          STATUS="${{ needs.deploy.result }}"
          [ "$STATUS" = "success" ] && COLOR=good TEXT="Deploy thành công" || COLOR=danger TEXT="Deploy thất bại"
          curl -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' \
            --data "{\"attachments\":[{\"color\":\"$COLOR\",\"title\":\"$TEXT • ${{ github.ref_name }}\",\"fields\":[{\"title\":\"Commit\",\"value\":\"<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\"},{\"title\":\"Run\",\"value\":\"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Log>\"}]}]}"
