name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_COMPOSE_VERSION: 2.23.0

jobs:
  test: 
    name: Run Tests
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code and download the latest code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd src/core
        pip install -r requirements.txt
    - name: Run linting
      run: |
        pip install flake8
        flake8 src/core --count --select=E9,F63,F7,F82 --show-source --statistics
  
  build:
    name: Build Docker Images
    runs-on: ubuntu-24.04
    needs: test
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build AI Backend Image
      run: |
        docker build -t ai-backend:${{ github.sha }} ./src/core
    - name: Build UI Frontend Image
      run: |
        docker build -t ui-frontend:${{ github.sha }} ./ui
    - name: Test images
      run: |
        docker images
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.VM_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
    - name: Deploy to production VM
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -p ${{ secrets.VM_SSH_PORT }} \
          ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} \
          'cd ${{ secrets.VM_DEPLOY_PATH }} && \
           git pull origin main && \
           docker compose down && \
           docker system prune -af && \
           docker compose up -d --build && \
           sleep 10 && \
           curl -f http://localhost:6033/health || exit 1 && \
           echo "Deploy successful"'
           
  notify:
    name: Send Notification
    runs-on: ubuntu-24.04
    needs: [test, build, deploy]
    if: always()

    steps:
    - name: Send Slack notification
      continue-on-error: true
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            COLOR="good"
            EMOJI="✅"
          elif [ "$STATUS" == "failure" ]; then
            COLOR="danger"
            EMOJI="❌"
          else
            COLOR="warning"
            EMOJI="⚠️"
          fi
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI CI/CD Pipeline $STATUS\",
                \"fields\": [
                  {
                    \"title\": \"Status\",
                    \"value\": \"$STATUS\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Commit\",
                    \"value\": \"<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Workflow\",
                    \"value\": \"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\",
                    \"short\": false
                  }
                ],
                \"footer\": \"GitHub Actions\",
                \"footer_icon\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                \"ts\": $(date +%s)
              }]
            }"
          echo "✅ Slack notification sent"
        else
          echo "⚠️ SLACK_WEBHOOK_URL not configured, skipping notification"
        fi