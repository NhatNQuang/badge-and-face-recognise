<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Detection - AI Human Detection</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">ü§ñ AI Detection</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="upload.html">Human Detection</a></li>
                <li><a href="camera.html">Human Camera</a></li>
                <li><a href="badge.html">Badge Detection</a></li>
                <li><a href="combined.html">Combined Detection</a></li>
                <li><a href="/docs" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 3rem 1.5rem; min-height: 80vh;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1>üì∏ Image Human Detection</h1>
            <p style="color: #b0b0b0; font-size: 1.2rem;">
                Upload an image to detect humans with AI-powered computer vision
            </p>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Drag & Drop Your Image Here</h3>
                <p style="color: #b0b0b0; margin: 1rem 0;">or</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Browse Files
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <p style="color: #888; font-size: 0.9rem; margin-top: 1.5rem;">
                    Supported formats: JPEG, PNG, WebP (Max 10MB)
                </p>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="hidden" style="margin-top: 2rem;">
            <div class="card">
                <h3>üì∑ Image Preview</h3>
                <div style="text-align: center; margin: 1.5rem 0;">
                    <img id="previewImage" class="image-preview" style="max-height: 400px;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" id="detectBtn">
                        üéØ Detect Humans
                    </button>
                    <button class="btn btn-secondary" id="cancelBtn">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden" style="margin-top: 2rem;">
            <div class="results">
                <h2>‚úÖ Detection Results</h2>

                <!-- Annotated Image -->
                <div style="text-align: center; margin: 2rem 0;">
                    <img id="resultImage" class="image-preview">
                </div>

                <!-- Detection Info -->
                <div class="detection-info">
                    <div class="info-card">
                        <div class="value" id="totalDetections">0</div>
                        <div class="label">People Detected</div>
                    </div>
                    <div class="info-card">
                        <div class="value" id="avgConfidence">0%</div>
                        <div class="label">Average Confidence</div>
                    </div>
                    <div class="info-card">
                        <div class="value" id="processingTime">0ms</div>
                        <div class="label">Processing Time</div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div style="margin-top: 2rem;">
                    <h3>üìä Detailed Detection Data</h3>
                    <div id="detectionDetails"
                        style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem; overflow-x: auto;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                    <button class="btn btn-success" id="downloadBtn">
                        üíæ Download Result
                    </button>
                    <button class="btn btn-primary" id="uploadAnotherBtn">
                        üì∏ Upload Another Image
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                        üè† Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 AI Human Detection System</p>
        </div>
    </footer>

    <script src="js/utils.js"></script>
    <script>
        let currentImageFile = null;
        let currentResultData = null;
        let startTime = 0;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const resultsSection = document.getElementById('resultsSection');
        const previewImage = document.getElementById('previewImage');
        const detectBtn = document.getElementById('detectBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // File input handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Handle file selection
        function handleFileSelect(file) {
            try {
                utils.validateImageFile(file);
                currentImageFile = file;

                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    uploadSection.classList.add('hidden');
                    previewSection.classList.remove('hidden');
                    resultsSection.classList.add('hidden');
                };
                reader.readAsDataURL(file);

                utils.showToast('Image loaded successfully!', 'success');
            } catch (error) {
                utils.showToast(error.message, 'error');
            }
        }

        // Cancel button
        cancelBtn.addEventListener('click', () => {
            resetUpload();
        });

        // Upload another button
        uploadAnotherBtn.addEventListener('click', () => {
            resetUpload();
        });

        // Reset upload
        function resetUpload() {
            currentImageFile = null;
            currentResultData = null;
            fileInput.value = '';
            uploadSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
        }

        // Detect button
        detectBtn.addEventListener('click', async () => {
            if (!currentImageFile) {
                utils.showToast('No image selected', 'error');
                return;
            }

            try {
                utils.showLoading();
                detectBtn.disabled = true;
                startTime = Date.now();

                // Create form data
                const formData = new FormData();
                formData.append('file', currentImageFile);

                // Call API
                const response = await fetch(`${API_BASE}/detect_human_by_image`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const processingTime = Date.now() - startTime;
                    displayResults(data, processingTime);
                    utils.showToast('Detection completed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Detection failed');
                }

            } catch (error) {
                utils.showToast(`Error: ${error.message}`, 'error');
                console.error('Detection error:', error);
            } finally {
                utils.hideLoading();
                detectBtn.disabled = false;
            }
        });

        // Display results
        function displayResults(data, processingTime) {
            currentResultData = data;

            // Show annotated image
            document.getElementById('resultImage').src = `data:image/jpeg;base64,${data.annotated_image}`;

            // Update statistics
            document.getElementById('totalDetections').textContent = data.total_detections;

            const avgConf = data.detections.confidence.length > 0
                ? utils.average(data.detections.confidence)
                : 0;
            document.getElementById('avgConfidence').textContent = utils.formatConfidence(avgConf);

            document.getElementById('processingTime').textContent = processingTime + 'ms';

            // Display detailed detection data
            const detailsHTML = data.detections.boxes_xyxy.map((box, index) => {
                return `
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                        <strong>Detection #${index + 1}</strong><br>
                        <span style="color: #b0b0b0;">Class:</span> ${utils.getClassName(data.detections.classes[index])}<br>
                        <span style="color: #b0b0b0;">Confidence:</span> ${utils.formatConfidence(data.detections.confidence[index])}<br>
                        <span style="color: #b0b0b0;">Bounding Box:</span> [${utils.formatBBox(box)}]
                    </div>
                `;
            }).join('');

            document.getElementById('detectionDetails').innerHTML = detailsHTML || '<p style="color: #888;">No detections found</p>';

            // Show results section
            previewSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
        }

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (currentResultData) {
                utils.downloadImage(currentResultData.annotated_image, `detection_${Date.now()}.jpg`);
                utils.showToast('Image downloaded!', 'success');
            }
        });
    </script>
</body>

</html>